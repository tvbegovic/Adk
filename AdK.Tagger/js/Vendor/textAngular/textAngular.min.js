/*
@license textAngular
Author : Austin Anderson
License : 2013 MIT
Version 1.5.12
See README.md or https://github.com/fraywing/textAngular/wiki for requirements and use.
*/
function stripHtmlToText(n){var t=document.createElement("DIV"),i;return t.innerHTML=n,i=t.textContent||t.innerText||"",i.replace("\u200b",""),i.trim()}function getDomFromHtml(n){var t=document.createElement("DIV");return t.innerHTML=n,t}var sheet,addCSSRule,removeCSSRule,_addCSSRule,_removeCSSRule,_getRuleIndex,_sheets,i,dropFired,textAngular;"use strict";var textAngularVersion="v1.5.12",_browserDetect={ie:function(){for(var i,n=3,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+ ++n+"]><i><\/i><![endif]-->",r[0];);return n>4?n:i}(),webkit:/AppleWebKit\/([\d.]+)/i.test(navigator.userAgent),isFirefox:navigator.userAgent.toLowerCase().indexOf("firefox")>-1},performance=performance||{};performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var BLOCKELEMENTS=/^(address|article|aside|audio|blockquote|canvas|center|dd|div|dl|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|noscript|ol|output|p|pre|section|table|tfoot|ul|video)$/i,LISTELEMENTS=/^(ul|li|ol)$/i,VALIDELEMENTS=/^(#text|span|address|article|aside|audio|blockquote|canvas|center|dd|div|dl|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|noscript|ol|output|p|pre|section|table|tfoot|ul|video|li)$/i;if(String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),_browserDetect.ie>8||_browserDetect.ie===undefined){for(_sheets=document.styleSheets,i=0;i<_sheets.length;i++)if((_sheets[i].media.length===0||_sheets[i].media.mediaText.match(/(all|screen)/ig))&&_sheets[i].href&&_sheets[i].href.match(/textangular\.(min\.|)css/ig)){sheet=_sheets[i];break}sheet||(sheet=function(){var n=document.createElement("style");return _browserDetect.webkit&&n.appendChild(document.createTextNode("")),document.getElementsByTagName("head")[0].appendChild(n),n.sheet}());addCSSRule=function(n,t){return _addCSSRule(sheet,n,t)};_addCSSRule=function(n,t,i){var r,u;return n.cssRules?r=Math.max(n.cssRules.length-1,0):n.rules&&(r=Math.max(n.rules.length-1,0)),n.insertRule?n.insertRule(t+"{"+i+"}",r):n.addRule(t,i,r),sheet.rules?u=sheet.rules[r]:sheet.cssRules&&(u=sheet.cssRules[r]),u};_getRuleIndex=function(n,t){for(var r,i=0;i<t.length;i++)if(t[i].cssText===n.cssText){r=i;break}return r};removeCSSRule=function(n){_removeCSSRule(sheet,n)};_removeCSSRule=function(n,t){var i=n.cssRules||n.rules,r;i&&i.length!==0&&(r=_getRuleIndex(t,i),n.removeRule?n.removeRule(r):n.deleteRule(r))}}angular.module("textAngular.factories",[]).factory("taBrowserTag",[function(){return function(n){return n?n===""?_browserDetect.ie===undefined?"div":_browserDetect.ie<=8?"P":"p":_browserDetect.ie<=8?n.toUpperCase():n:_browserDetect.ie<=8?"P":"p"}}]).factory("taApplyCustomRenderers",["taCustomRenderers","taDOM",function(n,t){return function(i){var r=angular.element("<div><\/div>");return r[0].innerHTML=i,angular.forEach(n,function(n){var i=[];n.selector&&n.selector!==""?i=r.find(n.selector):n.customAttribute&&n.customAttribute!==""&&(i=t.getByAttribute(r,n.customAttribute));angular.forEach(i,function(t){t=angular.element(t);n.selector&&n.selector!==""&&n.customAttribute&&n.customAttribute!==""?t.attr(n.customAttribute)!==undefined&&n.renderLogic(t):n.renderLogic(t)})}),r[0].innerHTML}}]).factory("taFixChrome",function(){return function(n){if(!n||!angular.isString(n)||n.length<=0)return n;for(var o=/<([^>\/]+?)style=("([^\"]+)"|'([^']+)')([^>]*)>/ig,s=/<span class="Apple-converted-space">([^<]+)<\/span>/ig,t,r,f,e,u="",i=0;t=s.exec(n);)f=t[1],f=f.replace(/&nbsp;/ig," "),u+=n.substring(i,t.index)+f,i=t.index+t[0].length;for(i&&(u+=n.substring(i),n=u,u="",i=0);t=o.exec(n);)r=t[3]||t[4],r&&r.match(/line-height: 1.[0-9]{3,12};|color: inherit; line-height: 1.1;|color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);|background-color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);/i)&&(r=r.replace(/( |)font-family: inherit;|( |)line-height: 1.[0-9]{3,12};|( |)color: inherit;|( |)color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);|( |)background-color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);/ig,""),e="<"+t[1].trim(),r.trim().length>0&&(e+=" style="+t[2].substring(0,1)+r+t[2].substring(0,1)),e+=t[5].trim()+">",u+=n.substring(i,t.index)+e,i=t.index+t[0].length);return u+=n.substring(i),i>0?u.replace(/<span\s?>(.*?)<\/span>(<br(\/|)>|)/ig,"$1"):n}}).factory("taSanitize",["$sanitize",function(n){function o(n,t){for(var i=0,r=0,u,f=/<[^>]*>/ig;u=f.exec(n);)if(r=u.index,u[0].substr(1,1)==="/")if(i===0)break;else i--;else i++;return t+n.substring(0,r)+angular.element(t)[0].outerHTML.substring(t.length)+n.substring(r)}function s(n){var y,p;if(!n||!angular.isString(n)||n.length<=0)return n;for(var u,w=/<([^>\/]+?)style=("([^"]+)"|'([^']+)')([^>]*)>/ig,i,v,r,l,e="",a,h="",c=0;i=w.exec(n);)if(r=i[3]||i[4],y=new RegExp(f,"i"),angular.isString(r)&&y.test(r)){for(l="",p=new RegExp(f,"ig");v=p.exec(r);)for(u=0;u<t.length;u++)!v[u*2+2]||(l+="<"+t[u].tag+">");a=s(n.substring(c,i.index));h+=e.length>0?o(a,e):a;r=r.replace(new RegExp(f,"ig"),"");h+="<"+i[1].trim();r.length>0&&(h+=' style="'+r+'"');h+=i[5]+">";c=i.index+i[0].length;e=l}return h+(e.length>0?o(n.substring(c),e):n.substring(c))}function c(n){var i;if(!n||!angular.isString(n)||n.length<=0)return n;for(var f=/<([^>\/]+?)align=("([^"]+)"|'([^']+)')([^>]*)>/ig,t,r="",u=0;t=f.exec(n);)r+=n.substring(u,t.index),u=t.index+t[0].length,i="<"+t[1]+t[5],/style=("([^"]+)"|'([^']+)')/ig.test(i)?i=i.replace(/style=("([^"]+)"|'([^']+)')/i,'style="$2$3 text-align:'+(t[3]||t[4])+';"'):i+=' style="text-align:'+(t[3]||t[4])+';"',i+=">",r+=i;return r+n.substring(u)}for(var r,u,f,t=[{property:"font-weight",values:["bold"],tag:"b"},{property:"font-style",values:["italic"],tag:"i"}],e=[],i=0;i<t.length;i++){for(r="("+t[i].property+":\\s*(",u=0;u<t[i].values.length;u++)u>0&&(r+="|"),r+=t[i].values[u];r+=");)";e.push(r)}f="("+e.join("|")+")";var h=new RegExp(/<span id="selectionBoundary_\d+_\d+" class="rangySelectionBoundary">[^<>]+?<\/span>/ig),l=new RegExp(/<span class="rangySelectionBoundary" id="selectionBoundary_\d+_\d+">[^<>]+?<\/span>/ig),a=new RegExp(/<span id="selectionBoundary_\d+_\d+" class="rangySelectionBoundary">[^<>]+?<\/span>/ig);return function(t,i,r){var u;if(!r)try{t=s(t)}catch(w){}if(t=c(t),t)try{t=t.replace(h,"");t=t.replace(l,"");t=t.replace(h,"");t=t.replace(a,"")}catch(w){}try{u=n(t);r&&(u=t)}catch(w){u=i||""}var y=u.match(/(<pre[^>]*>.*?<\/pre[^>]*>)/ig),e=u.replace(/(&#(9|10);)*/ig,""),p=/<pre[^>]*>.*?<\/pre[^>]*>/ig,o=0,v=0,f;for(u="";(f=p.exec(e))!==null&&o<y.length;)u+=e.substring(v,f.index)+y[o],v=f.index+f[0].length,o++;return u+e.substring(v)}}]).factory("taToolExecuteAction",["$q","$log",function(n,t){return function(i){i!==undefined&&(this.$editor=function(){return i});var r=n.defer(),e=r.promise,u=this.$editor(),f;try{f=this.action(r,u.startAction());e["finally"](function(){u.endAction.call(u)})}catch(o){t.error(o)}(f||f===undefined)&&r.resolve()}}]);angular.module("textAngular.DOM",["textAngular.factories"]).factory("taExecCommand",["taSelection","taBrowserTag","$document",function(n,t,i){var r=function(t,i){for(var u,f=t.find("li"),r=f.length-1;r>=0;r--)u=angular.element("<"+i+">"+f[r].innerHTML+"<\/"+i+">"),t.after(u);t.remove();n.setSelectionToElementEnd(u[0])},f=function(i,r,u,f,e){for(var h,p,w,s=i.find("li"),y,c,l,o=0;o<s.length;o++)if(s[o].outerHTML===r[0].outerHTML){y=o;o>0&&(p=s[o-1]);o+1<s.length&&(w=s[o+1]);break}if(c="",f?c+="<"+e+">"+r[0].innerHTML+"<\/"+e+">":(c+="<"+t(u)+">",c+="<li>"+r[0].innerHTML+"<\/li>",c+="<\/"+t(u)+">"),h=angular.element(c),p)if(w){var b=i.parent(),a="",v=i[0].nodeName.toLowerCase();for(a+="<"+v+">",o=0;o<y;o++)a+="<li>"+s[o].innerHTML+"<\/li>";for(a+="<\/"+v+">",l="",l+="<"+v+">",o=y+1;o<s.length;o++)l+="<li>"+s[o].innerHTML+"<\/li>";l+="<\/"+v+">";i.after(angular.element(l));i.after(h);i.after(angular.element(a));i.remove();n.setSelectionToElementEnd(h[0])}else r.remove(),i.after(h),n.setSelectionToElementEnd(h[0]);else{r.remove();i.after(angular.element(i[0].outerHTML));i.after(h);i.remove();n.setSelectionToElementEnd(h[0]);return}},h=function(i,r,u,f,e){for(var c,o,w,b,h=i.find("li"),l=[],a,v,y,p,s=0;s<h.length;s++)for(o=0;o<r.length;o++)h[s].isEqualNode(r[o])&&(l[o]=s);if(l[0]>0&&(w=h[l[0]-1]),l[r.length-1]+1<h.length&&(b=h[l[r.length-1]+1]),a="",f)for(o=0;o<r.length;o++)a+="<"+e+">"+r[o].innerHTML+"<\/"+e+">",r[o].remove();else{for(a+="<"+t(u)+">",o=0;o<r.length;o++)a+=r[o].outerHTML,r[o].remove();a+="<\/"+t(u)+">"}if(c=angular.element(a),w)if(b){for(v="",y=i[0].nodeName.toLowerCase(),v+="<"+y+">",s=0;s<l[0];s++)v+="<li>"+h[s].innerHTML+"<\/li>";for(v+="<\/"+y+">",p="",p+="<"+y+">",s=l[r.length-1]+1;s<h.length;s++)p+="<li>"+h[s].innerHTML+"<\/li>";p+="<\/"+y+">";i.after(angular.element(p));i.after(c);i.after(angular.element(v));i.remove();n.setSelectionToElementEnd(c[0])}else{i.after(c);n.setSelectionToElementEnd(c[0]);return}else{i.after(angular.element(i[0].outerHTML));i.after(c);i.remove();n.setSelectionToElementEnd(c[0]);return}},e=function(t){/(<br(|\/)>)$/i.test(t.innerHTML.trim())?n.setSelectionBeforeElement(angular.element(t).find("br")[0]):n.setSelectionToElementEnd(t)},u=function(n,t){var i=angular.element("<"+t+">"+n[0].innerHTML+"<\/"+t+">");n.after(i);n.remove();e(i.find("li")[0])},o=function(n,i,r){for(var f,o="",u=0;u<n.length;u++)o+="<"+t("li")+">"+n[u].innerHTML+"<\/"+t("li")+">";f=angular.element("<"+r+">"+o+"<\/"+r+">");i.after(f);i.remove();e(f.find("li")[0])},s=function(n,t){for(var r,u,i=0;i<n.childNodes.length;i++)r=n.childNodes[i],r.tagName&&r.tagName.match(BLOCKELEMENTS)&&s(r,t);return n.parentNode===null?n:(u=angular.element(t),u[0].innerHTML=n.innerHTML,n.parentNode.insertBefore(u[0],n),n.parentNode.removeChild(n),u)};return function(e,c){return e=t(e),function(l,a,v,y){var w,k,ut,p,yt,ft,d,tt,et=angular.element("<"+e+">"),b,ct,g,it,nt,rt,vt,lt,ht,at,ot,st,pt,kt;try{n.getSelection&&(tt=n.getSelection());d=n.getSelectionElement();d.tagName!==undefined&&(d.tagName.toLowerCase()==="div"&&/taTextElement.+/.test(d.id)&&tt&&tt.start&&tt.start.offset===1&&tt.end.offset===1?(b=d.innerHTML,/<br>/i.test(b)&&(b=b.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(b)&&(b=b.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(b)&&(b=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(b)&&(b=__.replace(/<\/span>(<\/span>)+/i,"<\/span>")),/<span><\/span>/i.test(b)&&(b=b.replace(/<span><\/span>/i,"")),ct="<div>"+b+"<\/div>",d.innerHTML=ct,n.setSelectionToElementEnd(d.childNodes[0]),d=n.getSelectionElement()):d.tagName.toLowerCase()==="span"&&tt&&tt.start&&tt.start.offset===1&&tt.end.offset===1?(b=d.innerHTML,/<br>/i.test(b)&&(b=b.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(b)&&(b=b.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(b)&&(b=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(b)&&(b=__.replace(/<\/span>(<\/span>)+/i,"<\/span>")),/<span><\/span>/i.test(b)&&(b=b.replace(/<span><\/span>/i,"")),ct="<div>"+b+"<\/div>",d.innerHTML=ct,n.setSelectionToElementEnd(d.childNodes[0]),d=n.getSelectionElement()):d.tagName.toLowerCase()==="p"&&tt&&tt.start&&tt.start.offset===1&&tt.end.offset===1?(b=d.innerHTML,/<br>/i.test(b)&&(b=b.replace(/<br>/i,"&#8203;"),d.innerHTML=b,n.setSelectionToElementEnd(d.childNodes[0]),d=n.getSelectionElement())):d.tagName.toLowerCase()==="li"&&tt&&tt.start&&tt.start.offset===tt.end.offset&&(b=d.innerHTML,/<br>/i.test(b)&&(b=b.replace(/<br>/i,""),d.innerHTML=b,n.setSelectionToElementEnd(d.childNodes[0]),d=n.getSelectionElement())))}catch(gt){}if(g=angular.element(d),it=d.tagName&&d.tagName.toLowerCase()||"",l.toLowerCase()==="insertorderedlist"||l.toLowerCase()==="insertunorderedlist"){if(nt=t(l.toLowerCase()==="insertorderedlist"?"ol":"ul"),rt=n.getOnlySelectedElements(),rt.length>1&&(it==="ol"||it==="ul"))return h(g,rt,nt,nt===it,e);if(it===nt)return g[0].childNodes.length!==rt.length&&rt.length===1?(g=angular.element(rt[0]),f(g.parent(),g,nt,!0,e)):r(g,e);if(it==="li"&&g.parent()[0].tagName.toLowerCase()===nt&&g.parent().children().length===1)return r(g.parent(),e);if(it==="li"&&g.parent()[0].tagName.toLowerCase()!==nt&&g.parent().children().length===1)return u(g.parent(),nt);if(it.match(BLOCKELEMENTS)&&!g.hasClass("ta-bind"))return rt.length&&g[0].childNodes.length!==rt.length&&rt.length===1?(g=angular.element(rt[0]),f(g.parent(),g,nt,nt===it,e)):it==="ol"||it==="ul"?u(g,nt):(vt=!1,angular.forEach(g.children(),function(n){n.tagName.match(BLOCKELEMENTS)&&(vt=!0)}),vt?o(g.children(),g,nt):o([angular.element("<div>"+d.innerHTML+"<\/div>")[0]],g,nt));if(it.match(BLOCKELEMENTS)){if(p=n.getOnlySelectedElements(),p.length===0)k=angular.element("<"+nt+"><li>"+d.innerHTML+"<\/li><\/"+nt+">"),g.html(""),g.append(k);else{if(p.length===1&&(p[0].tagName.toLowerCase()==="ol"||p[0].tagName.toLowerCase()==="ul"))return p[0].tagName.toLowerCase()===nt?r(angular.element(p[0]),e):u(angular.element(p[0]),nt);for(ut="",lt=[],w=0;w<p.length;w++)if(p[w].nodeType!==3){if(ht=angular.element(p[w]),p[w].tagName.toLowerCase()==="li")continue;else ut+=p[w].tagName.toLowerCase()==="ol"||p[w].tagName.toLowerCase()==="ul"?ht[0].innerHTML:p[w].tagName.toLowerCase()==="span"&&(p[w].childNodes[0].tagName.toLowerCase()==="ol"||p[w].childNodes[0].tagName.toLowerCase()==="ul")?ht[0].childNodes[0].innerHTML:"<"+t("li")+">"+ht[0].innerHTML+"<\/"+t("li")+">";lt.unshift(ht)}k=angular.element("<"+nt+">"+ut+"<\/"+nt+">");lt.pop().replaceWith(k);angular.forEach(lt,function(n){n.remove()})}n.setSelectionToElementEnd(k[0]);return}}else{if(l.toLowerCase()==="formatblock"){for(ft=v.toLowerCase().replace(/[<>]/ig,""),ft.trim()==="default"&&(ft=e,v="<"+e+">"),k=it==="li"?g.parent():g;!k[0].tagName||!k[0].tagName.match(BLOCKELEMENTS)&&!k.parent().attr("contenteditable");)k=k.parent(),it=(k[0].tagName||"").toLowerCase();if(it===ft){for(p=k.children(),at=!1,w=0;w<p.length;w++)at=at||p[w].tagName.match(BLOCKELEMENTS);at?(k.after(p),yt=k.next(),k.remove(),k=yt):(et.append(k[0].childNodes),k.after(et),k.remove(),k=et)}else if(k.parent()[0].tagName.toLowerCase()!==ft||k.parent().hasClass("ta-bind"))if(it.match(LISTELEMENTS))k.wrap(v);else{for(p=n.getOnlySelectedElements(),p.length===0&&(p=[k[0]]),w=0;w<p.length;w++)if(p[w].nodeType===3||!p[w].tagName.match(BLOCKELEMENTS))while(p[w].nodeType===3||!p[w].tagName||!p[w].tagName.match(BLOCKELEMENTS))p[w]=p[w].parentNode;if(p=p.filter(function(n,t,i){return i.indexOf(n)===t}),p.length>1&&(p=p.filter(function(n){return!(n.nodeName.toLowerCase()==="div"&&/^taTextElement/.test(n.id))})),angular.element(p[0]).hasClass("ta-bind"))k=angular.element(v),k[0].innerHTML=p[0].innerHTML,p[0].innerHTML=k[0].outerHTML;else if(ft==="blockquote"){for(ut="",w=0;w<p.length;w++)ut+=p[w].outerHTML;for(k=angular.element(v),k[0].innerHTML=ut,p[0].parentNode.insertBefore(k[0],p[0]),w=p.length-1;w>=0;w--)p[w].parentNode&&p[w].parentNode.removeChild(p[w])}else if(ft==="pre"&&n.getStateShiftKey()){for(ut="",w=0;w<p.length;w++)ut+=p[w].outerHTML;for(k=angular.element(v),k[0].innerHTML=ut,p[0].parentNode.insertBefore(k[0],p[0]),w=p.length-1;w>=0;w--)p[w].parentNode&&p[w].parentNode.removeChild(p[w])}else for(w=0;w<p.length;w++)pt=s(p[w],v),p[w]===k[0]&&(k=angular.element(pt))}else{for(ot=k.parent(),st=ot.contents(),w=0;w<st.length;w++)ot.parent().hasClass("ta-bind")&&st[w].nodeType===3&&(et=angular.element("<"+e+">"),et[0].innerHTML=st[w].outerHTML,st[w]=et[0]),ot.parent()[0].insertBefore(st[w],ot[0]);ot.remove()}n.setSelectionToElementEnd(k[0]);k[0].focus();return}if(l.toLowerCase()==="createlink"){if(it==="a"){n.getSelectionElement().href=v;return}var wt='<a href="'+v+'" target="'+(y.a.target?y.a.target:"")+'">',bt="<\/a>",dt=n.getSelection();dt.collapsed?n.insertHtml(wt+v+bt,c):rangy.getSelection().getRangeAt(0).canSurroundContents()&&(kt=angular.element(wt+bt)[0],rangy.getSelection().getRangeAt(0).surroundContents(kt));return}if(l.toLowerCase()==="inserthtml"){n.insertHtml(v,c);return}}try{i[0].execCommand(l,a,v)}catch(gt){}}}}]).service("taSelection",["$document","taDOM","$log",function(n,t){var r=n[0],u,f=function(n,t){return n.tagName&&n.tagName.match(/^br$/i)&&t===0&&!n.previousSibling?{element:n.parentNode,offset:0}:{element:n,offset:t}},i={getSelection:function(){var i,n,t;try{i=rangy.getSelection().getRangeAt(0)}catch(r){return undefined}return n=i.commonAncestorContainer,t={start:f(i.startContainer,i.startOffset),end:f(i.endContainer,i.endOffset),collapsed:i.collapsed},n.nodeType===3&&(n.parentNode.nodeName.toLowerCase()==="div"&&/^taTextElement/.test(n.parentNode.id)||(n=n.parentNode)),n.nodeName.toLowerCase()==="div"&&/^taTextElement/.test(n.id)?(t.start.element=n.childNodes[t.start.offset],t.end.element=n.childNodes[t.end.offset],t.container=n):t.container=n.parentNode===t.start.element||n.parentNode===t.end.element?n.parentNode:n,t},updateLeftArrowKey:function(){var t=rangy.getSelection().getRangeAt(0),n,o,r,u,f,e;if(t&&t.collapsed){if(n=i.getFlattenedDom(t),!n.findIndex)return;if(o=t.startContainer,r=n.findIndex(function(n){if(n.node===o)return!0;var t=n.parents.indexOf(o);return t!==-1}),n.forEach(function(n){n.parents.forEach(function(){})}),r+1<n.length&&(f=n[r+1].node),f&&f.textContent&&(u=/^\ufeff([^\ufeff]*)$/.exec(f.textContent),u))return;if(r>0&&(e=n[r-1].node),t.startOffset===0&&e&&(u=/^\ufeff([^\ufeff]*)$/.exec(e.textContent),u)){i.setSelectionToElementEnd(e);return}}return},updateRightArrowKey:function(){var n,r;if(!1&&(n=rangy.getSelection().getRangeAt(0),n&&n.collapsed)){if(r=i.getFlattenedDom(n),!r.findIndex)return;var t=n.startContainer,f=r.findIndex(function(n){if(n.node===t)return!0;var i=n.parents.indexOf(t);return i!==-1}),u,e=r.findIndex(function(n){if(n.textContent){var t=/^\ufeff([^\ufeff]*)$/.exec(n.textContent);return t?!0:!1}return!1});if(e===-1)return;if(t=r[f],t&&t.textContent&&(u=/^\ufeff([^\ufeff]*)$/.exec(t.textContent),u&&n.startOffset-1===u[1].length))return;if(r&&n.startOffset===0&&(f=r.indexOf(n.startContainer),f!==-1&&f>0&&(t=r[f-1],t.textContent&&(u=/\ufeff([^\ufeff]*)$/.exec(t.textContent),u&&!0||n.startOffset===u[1].length+1))))return}},getFlattenedDom:function(n){function u(n){if(n.node.childNodes.length){var t=Array.prototype.slice.call(n.node.childNodes);t.forEach(function(t){var i=n.parents.slice();i.slice(-1)[0]!==n.node&&i.push(n.node);u({parents:i,node:t})})}else i.push({parents:n.parents,node:n.node})}var t=n.commonAncestorContainer.parentNode,i,r;return t?(i=Array.prototype.slice.call(t.childNodes),r=i.indexOf(n.startContainer),r+1<i.length&&r>0||t.parentNode&&(t=t.parentNode),i=[],u({parents:[t],node:t}),i):n.commonAncestorContainer.childNodes},getOnlySelectedElements:function(){var t=rangy.getSelection().getRangeAt(0),n=t.commonAncestorContainer;return n=n.nodeType===3?n.parentNode:n,t.getNodes([1],function(t){return t.parentNode===n})},getAllSelectedElements:function(){var r=rangy.getSelection().getRangeAt(0),n=r.commonAncestorContainer,t,i,u,f;if(n=n.nodeType===3?n.parentNode:n,t=r.getNodes([1],function(t){return t.parentNode===n}),i=n.innerHTML,i=i.replace(/<span id=.selectionBoundary[^>]+>\ufeff?<\/span>/ig,""),i===r.toHtml()&&!(n.nodeName.toLowerCase()==="div"&&/^taTextElement/.test(n.id))){for(u=[],f=t.length;f--;u.unshift(t[f]));t=u;t.push(n)}return t},getSelectionElement:function(){var n=i.getSelection();return n?i.getSelection().container:undefined},setSelection:function(n,t,i,r){var u=rangy.createRange();u.setStart(n,i);u.setEnd(t,r);rangy.getSelection().setSingleRange(u)},setSelectionBeforeElement:function(n){var t=rangy.createRange();t.selectNode(n);t.collapse(!0);rangy.getSelection().setSingleRange(t)},setSelectionAfterElement:function(n){var t=rangy.createRange();t.selectNode(n);t.collapse(!1);rangy.getSelection().setSingleRange(t)},setSelectionToElementStart:function(n){var t=rangy.createRange();t.selectNodeContents(n);t.collapse(!0);rangy.getSelection().setSingleRange(t)},setSelectionToElementEnd:function(n){var t=rangy.createRange();t.selectNodeContents(n);t.collapse(!1);n.childNodes&&n.childNodes[n.childNodes.length-1]&&n.childNodes[n.childNodes.length-1].nodeName==="br"&&(t.startOffset=t.endOffset=t.startOffset-1);rangy.getSelection().setSingleRange(t)},setStateShiftKey:function(n){u=n},getStateShiftKey:function(){return u},insertHtml:function(n,u){var f,o,y,p,c,s,b,l=angular.element("<div>"+n+"<\/div>"),e=rangy.getSelection().getRangeAt(0),h=r.createDocumentFragment(),k=l[0].childNodes,a=!0,v,w,d;if(k.length>0){for(p=[],y=0;y<k.length;y++)(v=k[y],v.nodeName.toLowerCase()!=="p"||v.innerHTML.trim()!=="")&&(a=a&&!BLOCKELEMENTS.test(v.nodeName),p.push(v));for(w=0;w<p.length;w++)s=h.appendChild(p[w]);!a&&e.collapsed&&/^(|<br(|\/)>)$/i.test(e.startContainer.innerHTML)&&e.selectNode(e.startContainer)}else a=!0,s=h=r.createTextNode(n);if(a)e.deleteContents();else if(e.collapsed&&e.startContainer!==u)if(e.startContainer.innerHTML&&e.startContainer.innerHTML.match(/^<[^>]*>$/i))f=e.startContainer,e.startOffset===1?(e.setStartAfter(f),e.setEndAfter(f)):(e.setStartBefore(f),e.setEndBefore(f));else{if(e.startContainer.nodeType===3&&e.startContainer.parentNode!==u)for(f=e.startContainer.parentNode,o=f.cloneNode(),t.splitNodes(f.childNodes,f,o,e.startContainer,e.startOffset);!VALIDELEMENTS.test(f.nodeName);)angular.element(f).after(o),f=f.parentNode,d=o,o=f.cloneNode(),t.splitNodes(f.childNodes,f,o,d);else f=e.startContainer,o=f.cloneNode(),t.splitNodes(f.childNodes,f,o,undefined,undefined,e.startOffset);if(angular.element(f).after(o),e.setStartAfter(f),e.setEndAfter(f),/^(|<br(|\/)>)$/i.test(f.innerHTML.trim())&&(e.setStartBefore(f),e.setEndBefore(f),angular.element(f).remove()),/^(|<br(|\/)>)$/i.test(o.innerHTML.trim())&&angular.element(o).remove(),f.nodeName.toLowerCase()==="li"){for(b=r.createDocumentFragment(),c=0;c<h.childNodes.length;c++)l=angular.element("<li>"),t.transferChildNodes(h.childNodes[c],l[0]),t.transferNodeAttributes(h.childNodes[c],l[0]),b.appendChild(l[0]);h=b;s&&(s=h.childNodes[h.childNodes.length-1],s=s.childNodes[s.childNodes.length-1])}}else e.deleteContents();e.insertNode(h);s&&i.setSelectionToElementEnd(s)}};return i}]).service("taDOM",function(){var n={getByAttribute:function(t,i){var r=[],u=t.children();return u.length&&angular.forEach(u,function(t){r=r.concat(n.getByAttribute(angular.element(t),i))}),t.attr(i)!==undefined&&r.push(t),r},transferChildNodes:function(n,t){for(t.innerHTML="";n.childNodes.length>0;)t.appendChild(n.childNodes[0]);return t},splitNodes:function(t,i,r,u,f,e){if(!u&&isNaN(e))throw new Error("taDOM.splitNodes requires a splitNode or splitIndex");for(var o=document.createDocumentFragment(),s=document.createDocumentFragment(),h=0;t.length>0&&(isNaN(e)||e!==h)&&t[0]!==u;)o.appendChild(t[0]),h++;for(!isNaN(f)&&f>=0&&t[0]&&(o.appendChild(document.createTextNode(t[0].nodeValue.substring(0,f))),t[0].nodeValue=t[0].nodeValue.substring(f));t.length>0;)s.appendChild(t[0]);n.transferChildNodes(o,i);n.transferChildNodes(s,r)},transferNodeAttributes:function(n,t){for(var i=0;i<n.attributes.length;i++)t.setAttribute(n.attributes[i].name,n.attributes[i].value);return t}};return n});angular.module("textAngular.validators",[]).directive("taMaxText",function(){return{restrict:"A",require:"ngModel",link:function(n,t,i,r){var u=parseInt(n.$eval(i.taMaxText));if(isNaN(u))throw"Max text must be an integer";i.$observe("taMaxText",function(n){if(u=parseInt(n),isNaN(u))throw"Max text must be an integer";r.$dirty&&r.$validate()});r.$validators.taMaxText=function(n){var t=angular.element("<div/>");return t.html(n),t.text().length<=u}}}}).directive("taMinText",function(){return{restrict:"A",require:"ngModel",link:function(n,t,i,r){var u=parseInt(n.$eval(i.taMinText));if(isNaN(u))throw"Min text must be an integer";i.$observe("taMinText",function(n){if(u=parseInt(n),isNaN(u))throw"Min text must be an integer";r.$dirty&&r.$validate()});r.$validators.taMinText=function(n){var t=angular.element("<div/>");return t.html(n),!t.text().length||t.text().length>=u}}}});angular.module("textAngular.taBind",["textAngular.factories","textAngular.DOM"]).service("_taBlankTest",[function(){return function(n){if(!n)return!0;var t=stripHtmlToText(n);return t===""?/<img[^>]+>/.test(n)?!1:!0:!1}}]).directive("taButton",[function(){return{link:function(n,t){t.attr("unselectable","on");t.on("mousedown",function(n,t){return t&&angular.extend(n,t),n.preventDefault(),!1})}}}]).directive("taBind",["taSanitize","$timeout","$document","taFixChrome","taBrowserTag","taSelection","taSelectableElements","taApplyCustomRenderers","taOptions","_taBlankTest","$parse","taDOM","textAngularManager",function(n,t,i,r,u,f,e,o,s,h,c,l,a){return{priority:2,require:["ngModel","?ngModelOptions"],link:function(u,v,y,p){function ki(n){var t;return bi.forEach(function(i){if(i.keyCode===n.keyCode){var r=(n.metaKey?rt:0)+(n.ctrlKey?it:0)+(n.shiftKey?ft:0)+(n.altKey?ut:0);if(i.forbiddenModifiers&r)return;i.mustHaveModifiers.every(function(n){return r&n})&&(t=i.specialKey)}}),t}var w=p[0],wt=p[1]||{},k=v.attr("contenteditable")!==undefined&&v.attr("contenteditable"),fi=k||v[0].tagName.toLowerCase()==="textarea"||v[0].tagName.toLowerCase()==="input",b=!1,st=!1,at=!1,ei=y.taUnsafeSanitizer||s.disableSanitizer,oi,ai=/^(9|19|20|27|33|34|35|36|37|38|39|40|45|112|113|114|115|116|117|118|119|120|121|122|123|144|145)$/i,vi=/^(8|13|32|46|59|61|107|109|173|186|187|188|189|190|191|192|219|220|221|222)$/i,bt,d,si,it=1,rt=2,ut=4,ft=8,kt=13,yi=16,vt=9,pi=37,wi=39,bi=[{specialKey:"UndoKey",forbiddenModifiers:ut+ft,mustHaveModifiers:[rt+it],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:ut,mustHaveModifiers:[rt+it,ft],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:ut+ft,mustHaveModifiers:[rt+it],keyCode:89},{specialKey:"TabKey",forbiddenModifiers:rt+ft+ut+it,mustHaveModifiers:[],keyCode:vt},{specialKey:"ShiftTabKey",forbiddenModifiers:rt+ut+it,mustHaveModifiers:[ft],keyCode:vt}],dt,ht,ni,lt,ii,ri,ui,li,ot,yt,pt;y.taDefaultWrap===undefined&&(y.taDefaultWrap="p");y.taDefaultWrap===""?(d="",si=_browserDetect.ie===undefined?"<div><br><\/div>":_browserDetect.ie>=11?"<p><br><\/p>":_browserDetect.ie<=8?"<P>&nbsp;<\/P>":"<p>&nbsp;<\/p>"):(d=_browserDetect.ie===undefined||_browserDetect.ie>=11?y.taDefaultWrap.toLowerCase()==="br"?"<BR><BR>":"<"+y.taDefaultWrap+"><br><\/"+y.taDefaultWrap+">":_browserDetect.ie<=8?"<"+y.taDefaultWrap.toUpperCase()+"><\/"+y.taDefaultWrap.toUpperCase()+">":"<"+y.taDefaultWrap+"><\/"+y.taDefaultWrap+">",si=_browserDetect.ie===undefined||_browserDetect.ie>=11?y.taDefaultWrap.toLowerCase()==="br"?"<br><br>":"<"+y.taDefaultWrap+"><br><\/"+y.taDefaultWrap+">":_browserDetect.ie<=8?"<"+y.taDefaultWrap.toUpperCase()+">&nbsp;<\/"+y.taDefaultWrap.toUpperCase()+">":"<"+y.taDefaultWrap+">&nbsp;<\/"+y.taDefaultWrap+">");wt.$options||(wt.$options={});dt=function(n){var o,r,t,s,i,u,f,e;if(h(n))return n;if(o=angular.element("<div>"+n+"<\/div>"),o.children().length===0)n="<"+y.taDefaultWrap+">"+n+"<\/"+y.taDefaultWrap+">";else{for(r=o[0].childNodes,s=!1,t=0;t<r.length;t++)if(s=r[t].nodeName.toLowerCase().match(BLOCKELEMENTS))break;if(s)for(n="",t=0;t<r.length;t++)i=r[t],u=i.nodeName.toLowerCase(),u==="#comment"?n+="<!--"+i.nodeValue+"-->":u==="#text"?(f=i.textContent,n+=f.trim()?"<"+y.taDefaultWrap+">"+f+"<\/"+y.taDefaultWrap+">":f):u.match(BLOCKELEMENTS)?n+=i.outerHTML:(e=i.outerHTML||i.nodeValue,n+=e.trim()!==""?"<"+y.taDefaultWrap+">"+e+"<\/"+y.taDefaultWrap+">":e);else n="<"+y.taDefaultWrap+">"+n+"<\/"+y.taDefaultWrap+">"}return n};y.taPaste&&(bt=c(y.taPaste));v.addClass("ta-bind");u["$undoManager"+(y.id||"")]=w.$undoManager={_stack:[],_index:0,_max:1e3,push:function(n){return typeof n=="undefined"||n===null||typeof this.current()!="undefined"&&this.current()!==null&&n===this.current()?n:(this._index<this._stack.length-1&&(this._stack=this._stack.slice(0,this._index+1)),this._stack.push(n),ht&&t.cancel(ht),this._stack.length>this._max&&this._stack.shift(),this._index=this._stack.length-1,n)},undo:function(){return this.setToIndex(this._index-1)},redo:function(){return this.setToIndex(this._index+1)},setToIndex:function(n){return n<0||n>this._stack.length-1?undefined:(this._index=n,this.current())},current:function(){return this._stack[this._index]}};var g=function(){if(k)return v[0].innerHTML;if(fi)return v.val();throw"textAngular Error: attempting to update non-editable taBind";},ct=function(n){return u.$emit("ta-element-select",this),n.preventDefault(),!1},gt=u["reApplyOnSelectorHandlers"+(y.id||"")]=function(){b||angular.forEach(e,function(n){v.find(n).off("click",ct).on("click",ct)})},nt=function(n,t,i){at=i||!1;(typeof t=="undefined"||t===null)&&(t=!0&&k);(typeof n=="undefined"||n===null)&&(n=g());h(n)?(w.$viewValue!==""&&w.$setViewValue(""),t&&w.$undoManager.current()!==""&&w.$undoManager.push("")):(gt(),w.$viewValue!==n&&(w.$setViewValue(n),t&&w.$undoManager.push(n)));w.$render()},tt=function(n){v[0].innerHTML=n},et,di=u["$undoTaBind"+(y.id||"")]=function(){if(!b&&k){var n=w.$undoManager.undo();typeof n!="undefined"&&n!==null&&(tt(n),nt(n,!1),et&&t.cancel(et),et=t(function(){v[0].focus();f.setSelectionToElementEnd(v[0])},1))}},gi=u["$redoTaBind"+(y.id||"")]=function(){if(!b&&k){var n=w.$undoManager.redo();typeof n!="undefined"&&n!==null&&(tt(n),nt(n,!1),et&&t.cancel(et),et=t(function(){v[0].focus();f.setSelectionToElementEnd(v[0])},1))}};if(u["updateTaBind"+(y.id||"")]=function(){b||nt(undefined,undefined,!0)},ni=function(t){return w.$oldViewValue=n(r(t),w.$oldViewValue,ei)},v.attr("required")&&(w.$validators.required=function(n,t){return!h(n||t)}),w.$parsers.push(ni),w.$parsers.unshift(dt),w.$formatters.push(ni),w.$formatters.unshift(dt),w.$formatters.unshift(function(n){return w.$undoManager.push(n||"")}),fi)if(u.events={},k){lt=!1;ii=function(i){var ot=i!==undefined?i.match(/content=["']*OneNote.File/i):!1,s,it,c,o,e,p,ft,rt,nt,k,tt,ut;if(i&&i.trim().length){if(i.match(/class=["']*Mso(Normal|List)/i)||i.match(/content=["']*Word.Document/i)||i.match(/content=["']*OneNote.File/i)){s=i.match(/<!--StartFragment-->([\s\S]*?)<!--EndFragment-->/i);s=s?s[1]:i;s=s.replace(/<o:p>[\s\S]*?<\/o:p>/ig,"").replace(/class=(["']|)MsoNormal(["']|)/ig,"");var y=angular.element("<div>"+s+"<\/div>"),h=angular.element("<div><\/div>"),r={element:null,lastIndent:[],lastLi:null,isUl:!1};for(r.lastIndent.peek=function(){var n=this.length;if(n>0)return this[n-1]},it=function(n){r.isUl=n;r.element=angular.element(n?"<ul>":"<ol>");r.lastIndent=[];r.lastIndent.peek=function(){var n=this.length;if(n>0)return this[n-1]};r.lastLevelMatch=null},c=0;c<=y[0].childNodes.length;c++){if(y[0].childNodes[c]&&y[0].childNodes[c].nodeName!=="#text"){if(o=y[0].childNodes[c].tagName.toLowerCase(),o!=="p"&&o!=="h1"&&o!=="h2"&&o!=="h3"&&o!=="h4"&&o!=="h5"&&o!=="h6")continue}else continue;if(e=angular.element(y[0].childNodes[c]),p=(e.attr("class")||"").match(/MsoList(Bullet|Number|Paragraph)(CxSp(First|Middle|Last)|)/i),p){if(e[0].childNodes.length<2||e[0].childNodes[1].childNodes.length<1)continue;var d=p[1].toLowerCase()==="bullet"||p[1].toLowerCase()!=="number"&&!(/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(e[0].childNodes[1].innerHTML)||/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(e[0].childNodes[1].childNodes[0].innerHTML)),et=(e.attr("style")||"").match(/margin-left:([\-\.0-9]*)/i),a=parseFloat(et?et[1]:0),b=(e.attr("style")||"").match(/mso-list:l([0-9]+) level([0-9]+) lfo[0-9+]($|;)/i);if(b&&b[2]&&(a=parseInt(b[2])),(!b||r.lastLevelMatch&&b[1]===r.lastLevelMatch[1])&&p[3]&&p[3].toLowerCase()!=="first"&&r.lastIndent.peek()!==null&&(r.isUl===d||r.lastIndent.peek()!==a)){if(r.lastIndent.peek()!=null&&r.lastIndent.peek()<a)r.element=angular.element(d?"<ul>":"<ol>"),r.lastLi.append(r.element);else if(r.lastIndent.peek()!=null&&r.lastIndent.peek()>a){while(r.lastIndent.peek()!=null&&r.lastIndent.peek()>a){if(r.element.parent()[0].tagName.toLowerCase()==="li"){r.element=r.element.parent();continue}else if(/[uo]l/i.test(r.element.parent()[0].tagName.toLowerCase()))r.element=r.element.parent();else break;r.lastIndent.pop()}r.isUl=r.element[0].tagName.toLowerCase()==="ul";d!==r.isUl&&(it(d),h.append(r.element))}}else it(d),h.append(r.element);r.lastLevelMatch=b;a!==r.lastIndent.peek()&&r.lastIndent.push(a);r.lastLi=angular.element("<li>");r.element.append(r.lastLi);r.lastLi.html(e.html().replace(/<!(--|)\[if !supportLists\](--|)>[\s\S]*?<!(--|)\[endif\](--|)>/ig,""));e.remove()}else it(!1),h.append(e)}ft=function(n){n=angular.element(n);for(var t=n[0].childNodes.length-1;t>=0;t--)n.after(n[0].childNodes[t]);n.remove()};angular.forEach(h.find("span"),function(n){n.removeAttribute("lang");n.attributes.length<=0&&ft(n)});angular.forEach(h.find("font"),ft);i=h.html();ot&&(i=h.html()||y.html());i=i.replace(/\n/g," ")}else{if(i=i.replace(/<(|\/)meta[^>]*?>/ig,""),i.match(/<[^>]*?(ta-bind)[^>]*?>/)){if(i.match(/<[^>]*?(text-angular)[^>]*?>/)){for(rt=angular.element("<div>"+i+"<\/div>"),rt.find("textarea").remove(),nt=l.getByAttribute(rt,"ta-bind"),k=0;k<nt.length;k++){for(tt=nt[k][0].parentNode.parentNode,ut=0;ut<nt[k][0].childNodes.length;ut++)tt.parentNode.insertBefore(nt[k][0].childNodes[ut],tt);tt.parentNode.removeChild(tt)}i=rt.html().replace('<br class="Apple-interchange-newline">',"")}}else i.match(/^<span/)&&(i.match(/<span class=(\"Apple-converted-space\"|\'Apple-converted-space\')>.<\/span>/ig)||(i=i.replace(/<(|\/)span[^>]*?>/ig,"")));i=i.replace(/<br class="Apple-interchange-newline"[^>]*?>/ig,"").replace(/<span class="Apple-converted-space">( |&nbsp;)<\/span>/ig,"&nbsp;")}/<li(\s.*)?>/i.test(i)&&/(<ul(\s.*)?>|<ol(\s.*)?>).*<li(\s.*)?>/i.test(i)===!1&&(i=i.replace(/<li(\s.*)?>.*<\/li(\s.*)?>/i,"<ul>$&<\/ul>"));i=i.replace(/^[ |\u00A0]+/gm,function(n){for(var t="",i=0;i<n.length;i++)t+="&nbsp;";return t}).replace(/\n|\r\n|\r/g,"<br />").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;");bt&&(i=bt(u,{$html:i})||i);i=n(i,"",ei);f.insertHtml(i,v[0]);t(function(){w.$setViewValue(g());lt=!1;v.removeClass("processing-paste")},0)}else lt=!1,v.removeClass("processing-paste")};v.on("paste",u.events.paste=function(n,r){var s,u,e,o,h,f;if(r&&angular.extend(n,r),b||lt)return n.stopPropagation(),n.preventDefault(),!1;if(lt=!0,v.addClass("processing-paste"),u=(n.originalEvent||n).clipboardData,u&&u.getData&&u.types.length>0){for(e="",o=0;o<u.types.length;o++)e+=" "+u.types[o];return/text\/html/i.test(e)?s=u.getData("text/html"):/text\/plain/i.test(e)&&(s=u.getData("text/plain")),ii(s),n.stopPropagation(),n.preventDefault(),!1}h=rangy.saveSelection();f=angular.element('<div class="ta-hidden-input" contenteditable="true"><\/div>');i.find("body").append(f);f[0].focus();t(function(){rangy.restoreSelection(h);ii(f[0].innerHTML);v[0].focus();f.remove()},0)});v.on("cut",u.events.cut=function(n){b?n.preventDefault():t(function(){w.$setViewValue(g())},0)});v.on("keydown",u.events.keydown=function(n,t){var h,c,r,i,e,l,o;if(t&&angular.extend(n,t),n.keyCode===yi?f.setStateShiftKey(!0):f.setStateShiftKey(!1),n.specialKey=ki(n),s.keyMappings.forEach(function(t){n.specialKey===t.commandKeyCode&&(n.specialKey=undefined);t.testForKey(n)&&(h=t.commandKeyCode);(t.commandKeyCode==="UndoKey"||t.commandKeyCode==="RedoKey")&&(t.enablePropagation||n.preventDefault())}),typeof h!="undefined"&&(n.specialKey=h),typeof n.specialKey!="undefined"&&(n.specialKey!=="UndoKey"||n.specialKey!=="RedoKey")&&(n.preventDefault(),a.sendKeyCommand(u,n)),!b&&(n.specialKey==="UndoKey"&&(di(),n.preventDefault()),n.specialKey==="RedoKey"&&(gi(),n.preventDefault()),n.keyCode===kt&&!n.shiftKey&&!n.ctrlKey&&!n.metaKey&&!n.altKey)){if(c=function(n,t){for(var i=0;i<n.length;i++)if(n[i]===t)return!0;return!1},i=f.getSelectionElement(),!i.nodeName.match(VALIDELEMENTS))return;e=angular.element(d);l=["blockquote","ul","ol"];c(l,i.parentNode.tagName.toLowerCase())&&(/^<br(|\/)>$/i.test(i.innerHTML.trim())&&!i.nextSibling&&(r=angular.element(i),o=r.parent(),o.after(e),r.remove(),o.children().length===0&&o.remove(),f.setSelectionToElementStart(e[0]),n.preventDefault()),/^<[^>]+><br(|\/)><\/[^>]+>$/i.test(i.innerHTML.trim())&&(r=angular.element(i),r.after(e),r.remove(),f.setSelectionToElementStart(e[0]),n.preventDefault()))}});v.on("keyup",u.events.keyup=function(n,i){var s,r,e,u,o;if(i&&angular.extend(n,i),f.setStateShiftKey(!1),n.keyCode===vt){s=f.getSelection();s.start.element===v[0]&&v.children().length&&f.setSelectionToElementStart(v.children()[0]);return}if(n.keyCode!==pi||n.shiftKey||f.updateLeftArrowKey(v),n.keyCode!==wi||n.shiftKey||f.updateRightArrowKey(v),ht&&t.cancel(ht),!b&&!ai.test(n.keyCode)&&(n.keyCode!==kt||!(n.ctrlKey||n.metaKey||n.altKey))){if(d!==""&&d!=="<BR><BR>"&&n.keyCode===kt&&!n.ctrlKey&&!n.metaKey&&!n.altKey&&!n.shiftKey){for(r=f.getSelectionElement();!r.nodeName.match(VALIDELEMENTS)&&r!==v[0];)r=r.parentNode;r.tagName.toLowerCase()!==y.taDefaultWrap&&r.tagName.toLowerCase()!=="li"&&(r.innerHTML.trim()===""||r.innerHTML.trim()==="<br>")&&(e=angular.element(d),angular.element(r).replaceWith(e),f.setSelectionToElementStart(e[0]))}u=g();d!==""&&(u.trim()===""||u.trim()==="<br>")?(tt(d),f.setSelectionToElementStart(v.children()[0])):u.substring(0,1)!=="<"&&y.taDefaultWrap!=="";o=oi!==n.keyCode&&vi.test(n.keyCode);ri&&t.cancel(ri);ri=t(function(){nt(u,o,!0)},wt.$options.debounce||400);o||(ht=t(function(){w.$undoManager.push(u)},250));oi=n.keyCode}});v.on("input",function(){g()!==w.$viewValue&&(ui&&t.cancel(ui),ui=t(function(){var n=g();n!==w.$viewValue&&nt(n,!0)},1e3))});v.on("blur",u.events.blur=function(){st=!1;b?(at=!0,w.$render()):nt(undefined,undefined,!0)});if(y.placeholder&&(_browserDetect.ie>8||_browserDetect.ie===undefined)){if(y.id)li=addCSSRule("#"+y.id+".placeholder-text:before",'content: "'+y.placeholder+'"');else throw"textAngular Error: An unique ID is required for placeholders to work";u.$on("$destroy",function(){removeCSSRule(li)})}v.on("focus",u.events.focus=function(){st=!0;v.removeClass("placeholder-text");gt()});v.on("mouseup",u.events.mouseup=function(){var n=f.getSelection();n&&n.start.element===v[0]&&v.children().length&&f.setSelectionToElementStart(v.children()[0])});v.on("mousedown",u.events.mousedown=function(n,t){t&&angular.extend(n,t);n.stopPropagation()})}else{v.on("change blur",u.events.change=u.events.blur=function(){b||w.$setViewValue(g())});v.on("keydown",u.events.keydown=function(n,t){var f,u;if(t&&angular.extend(n,t),n.keyCode===vt){var r=this.selectionStart,e=this.selectionEnd,i=v.val();n.shiftKey?(f=i.lastIndexOf("\n",r),u=i.lastIndexOf("\t",r),u!==-1&&u>=f&&(v.val(i.substring(0,u)+i.substring(u+1)),this.selectionStart=this.selectionEnd=r-1)):(v.val(i.substring(0,r)+"\t"+i.substring(e)),this.selectionStart=this.selectionEnd=r+1);n.preventDefault()}});var ti=function(n,t){for(var i="",r=0;r<t;r++)i+=n;return i},hi=function(n,t,i){for(var r=0;r<n.length;r++)t.call(i,r,n[r])},ci=function(n,t){var i="",r=n.childNodes;return t++,i+=ti("\t",t-1)+n.outerHTML.substring(0,4),hi(r,function(n,r){var u=r.nodeName.toLowerCase();if(u==="#comment"){i+="<!--"+r.nodeValue+"-->";return}if(u==="#text"){i+=r.textContent;return}r.outerHTML&&(i+=u==="ul"||u==="ol"?"\n"+ci(r,t):"\n"+ti("\t",t)+r.outerHTML)}),i+="\n"+ti("\t",t-1)+n.outerHTML.substring(n.outerHTML.lastIndexOf("<"))};w.$formatters.unshift(function(n){var t=angular.element("<div>"+n+"<\/div>")[0].childNodes;return t.length>0&&(n="",hi(t,function(t,i){var r=i.nodeName.toLowerCase();if(r==="#comment"){n+="<!--"+i.nodeValue+"-->";return}if(r==="#text"){n+=i.textContent;return}i.outerHTML&&(n.length>0&&(n+="\n"),n+=r==="ul"||r==="ol"?""+ci(i,0):""+i.outerHTML)})),n})}if(ot=function(n,i){if(i&&angular.extend(n,i),!dropFired&&!b){dropFired=!0;var r;r=n.originalEvent?n.originalEvent.dataTransfer:n.dataTransfer;u.$emit("ta-drop-event",this,n,r);t(function(){dropFired=!1;nt(undefined,undefined,!0)},100)}},pt=!1,w.$render=function(){if(!pt){pt=!0;var n=w.$viewValue||"";if(!at)if(k&&st&&(v.removeClass("placeholder-text"),yt&&t.cancel(yt),yt=t(function(){st||(v[0].focus(),f.setSelectionToElementEnd(v.children()[v.children().length-1]));yt=undefined},1)),k)if(y.placeholder?n===""?tt(d):tt(n):tt(n===""?d:n),b)v.off("drop",ot);else{gt();v.on("drop",ot)}else v[0].tagName.toLowerCase()!=="textarea"&&v[0].tagName.toLowerCase()!=="input"?tt(o(n)):v.val(n);k&&y.placeholder&&(n===""?st?v.removeClass("placeholder-text"):v.addClass("placeholder-text"):v.removeClass("placeholder-text"));pt=at=!1}},y.taReadonly&&(b=u.$eval(y.taReadonly),b?(v.addClass("ta-readonly"),(v[0].tagName.toLowerCase()==="textarea"||v[0].tagName.toLowerCase()==="input")&&v.attr("disabled","disabled"),v.attr("contenteditable")!==undefined&&v.attr("contenteditable")&&v.removeAttr("contenteditable")):(v.removeClass("ta-readonly"),v[0].tagName.toLowerCase()==="textarea"||v[0].tagName.toLowerCase()==="input"?v.removeAttr("disabled"):k&&v.attr("contenteditable","true")),u.$watch(y.taReadonly,function(n,t){if(t!==n){if(n)v.addClass("ta-readonly"),(v[0].tagName.toLowerCase()==="textarea"||v[0].tagName.toLowerCase()==="input")&&v.attr("disabled","disabled"),v.attr("contenteditable")!==undefined&&v.attr("contenteditable")&&v.removeAttr("contenteditable"),angular.forEach(e,function(n){v.find(n).on("click",ct)}),v.off("drop",ot);else{v.removeClass("ta-readonly");v[0].tagName.toLowerCase()==="textarea"||v[0].tagName.toLowerCase()==="input"?v.removeAttr("disabled"):k&&v.attr("contenteditable","true");angular.forEach(e,function(n){v.find(n).off("click",ct)});v.on("drop",ot)}b=n}})),k&&!b){angular.forEach(e,function(n){v.find(n).on("click",ct)});v.on("drop",ot)}}}}]);dropFired=!1;textAngular=angular.module("textAngular",["ngSanitize","textAngularSetup","textAngular.factories","textAngular.DOM","textAngular.validators","textAngular.taBind"]);textAngular.config([function(){angular.forEach(taTools,function(n,t){delete taTools[t]})}]);textAngular.directive("textAngular",["$compile","$timeout","taOptions","taSelection","taExecCommand","textAngularManager","$document","$animate","$log","$q","$parse",function(n,t,i,r,u,f,e,o,s,h,c){return{require:"?ngModel",scope:{},restrict:"EA",priority:2,link:function(l,a,v,y){var tt,it,rt,ut,ft,et,d,b,p=v.serial?v.serial:Math.floor(Math.random()*10000000000000000),at,ot,st,ht,ct,nt,vt,g,k,lt,w;if(l._name=v.name?v.name:"textAngularEditor"+p,nt=function(n,i,r){t(function(){var t=function(){n.off(i,t);r.apply(this,arguments)};n.on(i,t)},100)},at=u(v.taDefaultWrap),angular.extend(l,angular.copy(i),{wrapSelection:function(n,t,i){n.toLowerCase()==="undo"?l["$undoTaBindtaTextElement"+p]():n.toLowerCase()==="redo"?l["$redoTaBindtaTextElement"+p]():(at(n,!1,t,l.defaultTagAttributes),i&&l["reApplyOnSelectorHandlerstaTextElement"+p](),l.displayElements.text[0].focus())},showHtml:l.$eval(v.taShowHtml)||!1}),v.taFocussedClass&&(l.classes.focussed=v.taFocussedClass),v.taTextEditorClass&&(l.classes.textEditor=v.taTextEditorClass),v.taHtmlEditorClass&&(l.classes.htmlEditor=v.taHtmlEditorClass),v.taDefaultTagAttributes)try{angular.extend(l.defaultTagAttributes,angular.fromJson(v.taDefaultTagAttributes))}catch(yt){s.error(yt)}v.taTextEditorSetup&&(l.setup.textEditorSetup=l.$parent.$eval(v.taTextEditorSetup));v.taHtmlEditorSetup&&(l.setup.htmlEditorSetup=l.$parent.$eval(v.taHtmlEditorSetup));l.fileDropHandler=v.taFileDrop?l.$parent.$eval(v.taFileDrop):l.defaultFileDropHandler;d=a[0].innerHTML;a[0].innerHTML="";l.displayElements={forminput:angular.element("<input type='hidden' tabindex='-1' style='display: none;'>"),html:angular.element("<textarea><\/textarea>"),text:angular.element("<div><\/div>"),scrollWindow:angular.element("<div class='ta-scroll-window'><\/div>"),popover:angular.element('<div class="popover fade bottom" style="max-width: none; width: 305px;"><\/div>'),popoverArrow:angular.element('<div class="arrow"><\/div>'),popoverContainer:angular.element('<div class="popover-content"><\/div>'),resize:{overlay:angular.element('<div class="ta-resizer-handle-overlay"><\/div>'),background:angular.element('<div class="ta-resizer-handle-background"><\/div>'),anchors:[angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-tl"><\/div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-tr"><\/div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-bl"><\/div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-br"><\/div>')],info:angular.element('<div class="ta-resizer-handle-info"><\/div>')}};l.displayElements.popover.append(l.displayElements.popoverArrow);l.displayElements.popover.append(l.displayElements.popoverContainer);l.displayElements.scrollWindow.append(l.displayElements.popover);l.displayElements.popover.on("mousedown",function(n,t){return t&&angular.extend(n,t),n.preventDefault(),!1});l.handlePopoverEvents=function(){l.displayElements.popover.css("display")==="block"&&(ht&&t.cancel(ht),ht=t(function(){l.reflowPopover(ct);l.reflowResizeOverlay(ct)},100))};angular.element(window).on("resize",function(){l.handlePopoverEvents()});angular.element(window).on("scroll",function(){l.handlePopoverEvents()});vt=function(n){var t,u={vertical:!1,horizontal:!1},i,r;try{if(t=window.getComputedStyle(n),t===null)return u}catch(f){return u}return i=t["overflow-y"],r=t["overflow-x"],{vertical:(i==="scroll"||i==="auto")&&n.scrollHeight>n.clientHeight,horizontal:(r==="scroll"||r==="auto")&&n.scrollWidth>n.clientWidth}};l.getScrollTop=function(n,t){var i=n.scrollTop;return(typeof i=="undefined"&&(i=0),t&&vt(n).vertical&&(n.removeEventListener("scroll",l._scrollListener,!1),n.addEventListener("scroll",l._scrollListener,!1)),i!==0)?{node:n.nodeName,top:i}:n.parentNode?l.getScrollTop(n.parentNode,t):{node:"<none>",top:0}};l.showPopover=function(n){l.getScrollTop(l.displayElements.scrollWindow[0],!0);l.displayElements.popover.css("display","block");ct=n;l.reflowPopover(n);o.addClass(l.displayElements.popover,"in");nt(e.find("body"),"click keyup",function(){l.hidePopover()})};l._scrollListener=function(){l.handlePopoverEvents()};l.reflowPopover=function(n){var f=l.getScrollTop(l.displayElements.scrollWindow[0],!1),e=n[0].offsetTop-f.top;e<51?(l.displayElements.popover.css("top",n[0].offsetTop+n[0].offsetHeight+l.displayElements.scrollWindow[0].scrollTop+"px"),l.displayElements.popover.removeClass("top").addClass("bottom")):(l.displayElements.popover.css("top",n[0].offsetTop-54+l.displayElements.scrollWindow[0].scrollTop+"px"),l.displayElements.popover.removeClass("bottom").addClass("top"));var i=l.displayElements.text[0].offsetWidth-l.displayElements.popover[0].offsetWidth,t=n[0].offsetLeft+n[0].offsetWidth/2-l.displayElements.popover[0].offsetWidth/2,r=Math.max(0,Math.min(i,t)),u=Math.min(t,Math.max(0,t-i))-11;r+=window.scrollX;u-=window.scrollX;l.displayElements.popover.css("left",r+"px");l.displayElements.popoverArrow.css("margin-left",u+"px")};l.hidePopover=function(){l.displayElements.popover.css("display","none");l.displayElements.popoverContainer.attr("style","");l.displayElements.popoverContainer.attr("class","popover-content");l.displayElements.popover.removeClass("in")};l.displayElements.resize.overlay.append(l.displayElements.resize.background);angular.forEach(l.displayElements.resize.anchors,function(n){l.displayElements.resize.overlay.append(n)});l.displayElements.resize.overlay.append(l.displayElements.resize.info);l.displayElements.scrollWindow.append(l.displayElements.resize.overlay);l.displayElements.resize.background.on("click",function(){l.displayElements.text[0].focus()});l.reflowResizeOverlay=function(n){n=angular.element(n)[0];l.displayElements.resize.overlay.css({display:"block",left:n.offsetLeft-5+"px",top:n.offsetTop-5+"px",width:n.offsetWidth+10+"px",height:n.offsetHeight+10+"px"});l.displayElements.resize.info.text(n.offsetWidth+" x "+n.offsetHeight)};l.showResizeOverlay=function(n){var t=e.find("body");ot=function(i){var r={width:parseInt(n.attr("width")),height:parseInt(n.attr("height")),x:i.clientX,y:i.clientY},u,f;(r.width===undefined||isNaN(r.width))&&(r.width=n[0].offsetWidth);(r.height===undefined||isNaN(r.height))&&(r.height=n[0].offsetHeight);l.hidePopover();u=r.height/r.width;f=function(t){function o(n){return Math.round(Math.max(0,n))}var i={x:Math.max(0,r.width+(t.clientX-r.x)),y:Math.max(0,r.height+(t.clientY-r.y))},s=v.taResizeForceAspectRatio!==undefined,h=v.taResizeMaintainAspectRatio,c=s||h&&!t.shiftKey,f,e;c&&(f=i.y/i.x,i.x=u>f?i.x:i.y/u,i.y=u>f?i.x*u:i.y);e=angular.element(n);e.css("height",o(i.y)+"px");e.css("width",o(i.x)+"px");l.reflowResizeOverlay(n)};t.on("mousemove",f);nt(t,"mouseup",function(n){n.preventDefault();n.stopPropagation();t.off("mousemove",f);l.$apply(function(){l.hidePopover();l.updateTaBindtaTextElement()},100)});i.stopPropagation();i.preventDefault()};l.displayElements.resize.anchors[3].off("mousedown");l.displayElements.resize.anchors[3].on("mousedown",ot);l.reflowResizeOverlay(n);nt(t,"click",function(){l.hideResizeOverlay()})};l.hideResizeOverlay=function(){l.displayElements.resize.anchors[3].off("mousedown",ot);l.displayElements.resize.overlay.css("display","none")};l.setup.htmlEditorSetup(l.displayElements.html);l.setup.textEditorSetup(l.displayElements.text);l.displayElements.html.attr({id:"taHtmlElement"+p,"ng-show":"showHtml","ta-bind":"ta-bind","ng-model":"html","ng-model-options":a.attr("ng-model-options")});l.displayElements.text.attr({id:"taTextElement"+p,contentEditable:"true","ta-bind":"ta-bind","ng-model":"html","ng-model-options":a.attr("ng-model-options")});l.displayElements.scrollWindow.attr({"ng-hide":"showHtml"});v.taDefaultWrap&&l.displayElements.text.attr("ta-default-wrap",v.taDefaultWrap);v.taUnsafeSanitizer&&(l.displayElements.text.attr("ta-unsafe-sanitizer",v.taUnsafeSanitizer),l.displayElements.html.attr("ta-unsafe-sanitizer",v.taUnsafeSanitizer));l.displayElements.scrollWindow.append(l.displayElements.text);a.append(l.displayElements.scrollWindow);a.append(l.displayElements.html);l.displayElements.forminput.attr("name",l._name);a.append(l.displayElements.forminput);v.tabindex&&(a.removeAttr("tabindex"),l.displayElements.text.attr("tabindex",v.tabindex),l.displayElements.html.attr("tabindex",v.tabindex));v.placeholder&&(l.displayElements.text.attr("placeholder",v.placeholder),l.displayElements.html.attr("placeholder",v.placeholder));v.taDisabled&&(l.displayElements.text.attr("ta-readonly","disabled"),l.displayElements.html.attr("ta-readonly","disabled"),l.disabled=l.$parent.$eval(v.taDisabled),l.$parent.$watch(v.taDisabled,function(n){l.disabled=n;l.disabled?a.addClass(l.classes.disabled):a.removeClass(l.classes.disabled)}));v.taPaste&&(l._pasteHandler=function(n){return c(v.taPaste)(l.$parent,{$html:n})},l.displayElements.text.attr("ta-paste","_pasteHandler($html)"));n(l.displayElements.scrollWindow)(l);n(l.displayElements.html)(l);l.updateTaBindtaTextElement=l["updateTaBindtaTextElement"+p];l.updateTaBindtaHtmlElement=l["updateTaBindtaHtmlElement"+p];a.addClass("ta-root");l.displayElements.scrollWindow.addClass("ta-text ta-editor "+l.classes.textEditor);l.displayElements.html.addClass("ta-html ta-editor "+l.classes.htmlEditor);g=function(n,t){t!==e[0].queryCommandState(n)&&e[0].execCommand(n,!1,null)};l._actionRunning=!1;k=!1;l.startAction=function(){var n=!1,t=!1,i=!1,r=!1;return l._actionRunning=!0,n=e[0].queryCommandState("bold"),t=e[0].queryCommandState("italic"),i=e[0].queryCommandState("underline"),r=e[0].queryCommandState("strikeThrough"),k=rangy.saveSelection(),g("bold",n),g("italic",t),g("underline",i),g("strikeThrough",r),function(){k&&rangy.restoreSelection(k)}};l.endAction=function(){l._actionRunning=!1;k&&(l.showHtml?l.displayElements.html[0].focus():l.displayElements.text[0].focus(),rangy.removeMarkers(k));k=!1;l.updateSelectedStyles();l.showHtml||l["updateTaBindtaTextElement"+p]()};ft=function(){l.focussed=!0;a.addClass(l.classes.focussed);b.focus();a.triggerHandler("focus");l.updateSelectedStyles&&!l._bUpdateSelectedStyles&&t(function(){l.updateSelectedStyles()},0)};l.displayElements.html.on("focus",ft);l.displayElements.text.on("focus",ft);et=function(n){return l._actionRunning||e[0].activeElement===l.displayElements.html[0]||e[0].activeElement===l.displayElements.text[0]||(a.removeClass(l.classes.focussed),b.unfocus(),t(function(){l._bUpdateSelectedStyles=!1;a.triggerHandler("blur");l.focussed=!1},0)),n.preventDefault(),!1};l.displayElements.html.on("blur",et);l.displayElements.text.on("blur",et);l.displayElements.text.on("paste",function(n){a.triggerHandler("paste",n)});l.queryFormatBlockState=function(n){return!l.showHtml&&n.toLowerCase()===e[0].queryCommandValue("formatBlock").toLowerCase()};l.queryCommandState=function(n){return l.showHtml?"":e[0].queryCommandState(n)};l.switchView=function(){l.showHtml=!l.showHtml;o.enabled(!1,l.displayElements.html);o.enabled(!1,l.displayElements.text);l.showHtml?t(function(){return o.enabled(!0,l.displayElements.html),o.enabled(!0,l.displayElements.text),l.displayElements.html[0].focus()},100):t(function(){return o.enabled(!0,l.displayElements.html),o.enabled(!0,l.displayElements.text),l.displayElements.text[0].focus()},100)};v.ngModel?(lt=!0,y.$render=function(){if(lt){lt=!1;var n=l.$parent.$eval(v.ngModel);(n===undefined||n===null)&&d&&d!==""&&y.$setViewValue(d)}l.displayElements.forminput.val(y.$viewValue);l.html=y.$viewValue||""},a.attr("required")&&(y.$validators.required=function(n,t){var i=n||t;return!(!i||i.trim()==="")})):(l.displayElements.forminput.val(d),l.html=d);l.$watch("html",function(n,t){n!==t&&(v.ngModel&&y.$viewValue!==n&&y.$setViewValue(n),l.displayElements.forminput.val(n))});v.taTargetToolbars?b=f.registerEditor(l._name,l,v.taTargetToolbars.split(",")):(w=angular.element('<div text-angular-toolbar name="textAngularToolbar'+p+'">'),v.taToolbar&&w.attr("ta-toolbar",v.taToolbar),v.taToolbarClass&&w.attr("ta-toolbar-class",v.taToolbarClass),v.taToolbarGroupClass&&w.attr("ta-toolbar-group-class",v.taToolbarGroupClass),v.taToolbarButtonClass&&w.attr("ta-toolbar-button-class",v.taToolbarButtonClass),v.taToolbarActiveButtonClass&&w.attr("ta-toolbar-active-button-class",v.taToolbarActiveButtonClass),v.taFocussedClass&&w.attr("ta-focussed-class",v.taFocussedClass),a.prepend(w),n(w)(l.$parent),b=f.registerEditor(l._name,l,["textAngularToolbar"+p]));l.$on("$destroy",function(){f.unregisterEditor(l._name);angular.element(window).off("blur")});l.$on("ta-element-select",function(n,t){b.triggerElementSelect(n,t)&&l["reApplyOnSelectorHandlerstaTextElement"+p]()});l.$on("ta-drop-event",function(n,i,r,u){u&&u.files&&u.files.length>0?(l.displayElements.text[0].focus(),angular.forEach(u.files,function(n){try{h.when(l.fileDropHandler(n,l.wrapSelection)||l.fileDropHandler!==l.defaultFileDropHandler&&h.when(l.defaultFileDropHandler(n,l.wrapSelection))).then(function(){l["updateTaBindtaTextElement"+p]()})}catch(t){s.error(t)}}),r.preventDefault(),r.stopPropagation()):t(function(){l["updateTaBindtaTextElement"+p]()},0)});l._bUpdateSelectedStyles=!1;angular.element(window).on("blur",function(){l._bUpdateSelectedStyles=!1;l.focussed=!1});l.updateSelectedStyles=function(){var n;st&&t.cancel(st);(n=r.getSelectionElement())!==undefined&&n.parentNode!==l.displayElements.text[0]?b.updateSelectedStyles(angular.element(n)):b.updateSelectedStyles();l._bUpdateSelectedStyles&&(st=t(l.updateSelectedStyles,200))};tt=function(){if(!l.focussed){l._bUpdateSelectedStyles=!1;return}l._bUpdateSelectedStyles||(l._bUpdateSelectedStyles=!0,l.$apply(function(){l.updateSelectedStyles()}))};l.displayElements.html.on("keydown",tt);l.displayElements.text.on("keydown",tt);it=function(){l._bUpdateSelectedStyles=!1};l.displayElements.html.on("keyup",it);l.displayElements.text.on("keyup",it);rt=function(n,t){if(r.getSelection){var i=r.getSelection();r.getSelectionElement()&&r.getSelectionElement().nodeName.toLowerCase()==="a"&&(i.start.element.nodeType===3&&i.start.element.textContent.length===i.end.offset&&r.setSelectionAfterElement(r.getSelectionElement()),i.start.element.nodeType===3&&i.start.offset===0&&r.setSelectionBeforeElement(r.getSelectionElement()))}t&&angular.extend(n,t);l.$apply(function(){if(b.sendKeyCommand(n))return l._bUpdateSelectedStyles||l.updateSelectedStyles(),n.preventDefault(),!1})};l.displayElements.html.on("keypress",rt);l.displayElements.text.on("keypress",rt);ut=function(){l._bUpdateSelectedStyles=!1;t(function(){l.updateSelectedStyles()},0)};l.displayElements.html.on("mouseup",ut);l.displayElements.text.on("mouseup",ut)}}}]);textAngular.service("textAngularManager",["taToolExecuteAction","taTools","taRegisterTool","$interval","$rootScope","$log",function(n,t,i,r,u){var e={},f={},h=0,c=function(n){angular.forEach(f,function(t){t.editorFunctions.updateSelectedStyles(n)})},l=50,s,a=function(){h=Date.now();s=r(function(){c();s=undefined},l,1)},o;return u.$on("destroy",function(){s&&(r.cancel(s),s=undefined)}),o=function(){Math.abs(Date.now()-h)>l&&a()},{registerEditor:function(i,r,u){if(!i||i==="")throw"textAngular Error: An editor requires a name";if(!r)throw"textAngular Error: An editor requires a scope";if(f[i])throw'textAngular Error: An Editor with name "'+i+'" already exists';return f[i]={scope:r,toolbars:u,toolbarScopes:[],_registerToolbarScope:function(n){this.toolbars.indexOf(n.name)>=0&&this.toolbarScopes.push(n)},editorFunctions:{disable:function(){angular.forEach(f[i].toolbarScopes,function(n){n.disabled=!0})},enable:function(){angular.forEach(f[i].toolbarScopes,function(n){n.disabled=!1})},focus:function(){angular.forEach(f[i].toolbarScopes,function(n){n._parent=r;n.disabled=!1;n.focussed=!0});r.focussed=!0},unfocus:function(){angular.forEach(f[i].toolbarScopes,function(n){n.disabled=!0;n.focussed=!1});r.focussed=!1},updateSelectedStyles:function(n){angular.forEach(f[i].toolbarScopes,function(t){angular.forEach(t.tools,function(i){i.activeState&&(t._parent=r,i.active=i.activeState(n))})})},sendKeyCommand:function(u){var e=!1;return(u.ctrlKey||u.metaKey||u.specialKey)&&angular.forEach(t,function(t,o){if(t.commandKeyCode&&(t.commandKeyCode===u.which||t.commandKeyCode===u.specialKey))for(var s=0;s<f[i].toolbarScopes.length;s++)if(f[i].toolbarScopes[s].tools[o]!==undefined){n.call(f[i].toolbarScopes[s].tools[o],r);e=!0;break}}),e},triggerElementSelect:function(n,u){var c=function(n,t){for(var i=!0,r=0;r<t.length;r++)i=i&&n.attr(t[r]);return i},e=[],l={},a=!1,h,o,y,v,s;if(u=angular.element(u),h=!1,angular.forEach(t,function(n,t){n.onElementSelect&&n.onElementSelect.element&&n.onElementSelect.element.toLowerCase()===u[0].tagName.toLowerCase()&&(!n.onElementSelect.filter||n.onElementSelect.filter(u))&&(h=h||angular.isArray(n.onElementSelect.onlyWithAttrs)&&c(u,n.onElementSelect.onlyWithAttrs),(!n.onElementSelect.onlyWithAttrs||c(u,n.onElementSelect.onlyWithAttrs))&&(l[t]=n))}),h?(angular.forEach(l,function(n,t){n.onElementSelect.onlyWithAttrs&&c(u,n.onElementSelect.onlyWithAttrs)&&e.push({name:t,tool:n})}),e.sort(function(n,t){return t.tool.onElementSelect.onlyWithAttrs.length-n.tool.onElementSelect.onlyWithAttrs.length})):angular.forEach(l,function(n,t){e.push({name:t,tool:n})}),e.length>0)for(o=0;o<e.length;o++){for(y=e[o].tool,v=e[o].name,s=0;s<f[i].toolbarScopes.length;s++)if(f[i].toolbarScopes[s].tools[v]!==undefined){y.onElementSelect.action.call(f[i].toolbarScopes[s].tools[v],n,u,r);a=!0;break}if(a)break}return a}}},angular.forEach(u,function(n){e[n]&&f[i].toolbarScopes.push(e[n])}),o(),f[i].editorFunctions},retrieveEditor:function(n){return f[n]},unregisterEditor:function(n){delete f[n];o()},registerToolbar:function(n){if(!n)throw"textAngular Error: A toolbar requires a scope";if(!n.name||n.name==="")throw"textAngular Error: A toolbar requires a name";if(e[n.name])throw'textAngular Error: A toolbar with name "'+n.name+'" already exists';e[n.name]=n;angular.forEach(f,function(t){t._registerToolbarScope(n)});o()},retrieveToolbar:function(n){return e[n]},retrieveToolbarsViaEditor:function(n){var t=[],i=this;return angular.forEach(this.retrieveEditor(n).toolbars,function(n){t.push(i.retrieveToolbar(n))}),t},unregisterToolbar:function(n){delete e[n];o()},updateToolsDisplay:function(n){var t=this;angular.forEach(n,function(n,i){t.updateToolDisplay(i,n)})},resetToolsDisplay:function(){var n=this;angular.forEach(t,function(t,i){n.resetToolDisplay(i)});o()},updateToolDisplay:function(n,t){var i=this;angular.forEach(e,function(r,u){i.updateToolbarToolDisplay(u,n,t)});o()},resetToolDisplay:function(n){var t=this;angular.forEach(e,function(i,r){t.resetToolbarToolDisplay(r,n)});o()},updateToolbarToolDisplay:function(n,t,i){if(e[n])e[n].updateToolDisplay(t,i);else throw'textAngular Error: No Toolbar with name "'+n+'" exists';},resetToolbarToolDisplay:function(n,i){if(e[n])e[n].updateToolDisplay(i,t[i],!0);else throw'textAngular Error: No Toolbar with name "'+n+'" exists';},removeTool:function(n){delete t[n];angular.forEach(e,function(t){var r,i,u;for(delete t.tools[n],r=0;r<t.toolbar.length;r++){for(u=0;u<t.toolbar[r].length;u++){if(t.toolbar[r][u]===n){i={group:r,index:u};break}if(i!==undefined)break}i!==undefined&&(t.toolbar[i.group].slice(i.index,1),t._$element.children().eq(i.group).children().eq(i.index).remove())}});o()},addTool:function(n,t,r,u){i(n,t);angular.forEach(e,function(i){i.addTool(n,t,r,u)});o()},addToolToToolbar:function(n,t,r,u,f){i(n,t);e[r].addTool(n,t,u,f);o()},refreshEditor:function(n){if(f[n])f[n].scope.updateTaBindtaTextElement(),f[n].scope.$$phase||f[n].scope.$digest();else throw'textAngular Error: No Editor with name "'+n+'" exists';o()},sendKeyCommand:function(n,t){var i=f[n._name];if(i&&i.editorFunctions.sendKeyCommand(t))return n._bUpdateSelectedStyles||n.updateSelectedStyles(),t.preventDefault(),!1},updateStyles:c,getVersion:function(){return textAngularVersion},getToolbarScopes:function(){var n=[];return angular.forEach(f,function(t){n=n.concat(t.toolbarScopes)}),n}}}]);textAngular.directive("textAngularToolbar",["$compile","textAngularManager","taOptions","taTools","taToolExecuteAction","$window",function(n,t,i,r,u,f){return{scope:{name:"@"},restrict:"EA",link:function(e,o,s){var h,c;if(!e.name||e.name==="")throw"textAngular Error: A toolbar requires a name";angular.extend(e,angular.copy(i));s.taToolbar&&(e.toolbar=e.$parent.$eval(s.taToolbar));s.taToolbarClass&&(e.classes.toolbar=s.taToolbarClass);s.taToolbarGroupClass&&(e.classes.toolbarGroup=s.taToolbarGroupClass);s.taToolbarButtonClass&&(e.classes.toolbarButton=s.taToolbarButtonClass);s.taToolbarActiveButtonClass&&(e.classes.toolbarButtonActive=s.taToolbarActiveButtonClass);s.taFocussedClass&&(e.classes.focussed=s.taFocussedClass);e.disabled=!0;e.focussed=!1;e._$element=o;o[0].innerHTML="";o.addClass("ta-toolbar "+e.classes.toolbar);e.$watch("focussed",function(){e.focussed?o.addClass(e.classes.focussed):o.removeClass(e.classes.focussed)});h=function(t,i){var r,f,u;return r=t&&t.display?angular.element(t.display):angular.element("<button type='button'>"),t&&t["class"]?r.addClass(t["class"]):r.addClass(e.classes.toolbarButton),r.attr("name",i.name),r.attr("ta-button","ta-button"),r.attr("ng-disabled","isDisabled()"),r.attr("tabindex","-1"),r.attr("ng-click","executeAction()"),r.attr("ng-class","displayActiveToolClass(active)"),t&&t.tooltiptext&&r.attr("title",t.tooltiptext),!t||t.display||i._display||(r[0].innerHTML="",t.buttontext&&(r[0].innerHTML=t.buttontext),t.iconclass&&(f=angular.element("<i>"),u=r[0].innerHTML,f.addClass(t.iconclass),r[0].innerHTML="",r.append(f),u&&u!==""&&r.append("&nbsp;"+u))),i._lastToolDefinition=angular.copy(t),n(r)(i)};e.tools={};e._parent={disabled:!0,showHtml:!1,queryFormatBlockState:function(){return!1},queryCommandState:function(){return!1}};c={$window:f,$editor:function(){return e._parent},isDisabled:function(){return this.name==="html"&&e._parent.startAction?!1:typeof this.$eval("disabled")!="function"&&this.$eval("disabled")||this.$eval("disabled()")||this.name!=="html"&&this.$editor().showHtml||this.$parent.disabled||this.$editor().disabled},displayActiveToolClass:function(n){return n?e.classes.toolbarButtonActive:""},executeAction:u};angular.forEach(e.toolbar,function(n){var t=angular.element("<div>");t.addClass(e.classes.toolbarGroup);angular.forEach(n,function(n){e.tools[n]=angular.extend(e.$new(!0),r[n],c,{name:n});e.tools[n].$element=h(r[n],e.tools[n]);t.append(e.tools[n].$element)});o.append(t)});e.updateToolDisplay=function(n,t,i){var r=e.tools[n],u;if(r){if(r._lastToolDefinition&&!i&&(t=angular.extend({},r._lastToolDefinition,t)),t.buttontext===null&&t.iconclass===null&&t.display===null)throw'textAngular Error: Tool Definition for updating "'+n+'" does not have a valid display/iconclass/buttontext value';t.buttontext===null&&delete t.buttontext;t.iconclass===null&&delete t.iconclass;t.display===null&&delete t.display;u=h(t,r);r.$element.replaceWith(u);r.$element=u}};e.addTool=function(n,t,i,u){e.tools[n]=angular.extend(e.$new(!0),r[n],c,{name:n});e.tools[n].$element=h(r[n],e.tools[n]);var f;i===undefined&&(i=e.toolbar.length-1);f=angular.element(o.children()[i]);u===undefined?(f.append(e.tools[n].$element),e.toolbar[i][e.toolbar[i].length-1]=n):(f.children().eq(u).after(e.tools[n].$element),e.toolbar[i][u]=n)};t.registerToolbar(e);e.$on("$destroy",function(){t.unregisterToolbar(e.name)})}}}]);textAngular.directive("textAngularVersion",["textAngularManager",function(n){var t=n.getVersion();return{restrict:"EA",link:function(n,i){i.html(t)}}}]);